<div class="wpm-custom-gradient p-6 rounded-lg shadow-md">
  <div class="flex justify-between items-center mb-4">
    <div class="contenedor">
      <div *ngIf="authService.getUserId() as rut">

        <h1 class="text-2xl font-bold text-center mb-4">Ordenes de Trabajo</h1>
        <button (click)="showFilters = !showFilters" class="bg-gray-500 text-white p-2 rounded mb-4">
          {{ showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
        </button>
        <div *ngIf="showFilters" class="filters-container">
          <h2 class="filters-title">Filtros</h2>
        
          <!-- Filtrar por Estado -->
          <div class="filter-group">
            <h3 class="filter-header">Filtrar por estado</h3>
            <label for="stateFilter" class="sr-only">Filtrar por estado</label>
            <select id="stateFilter" class="filter-select" (change)="onStateChange($event)">
              <option value="todas">Todas</option>
              <option value="pendiente">Pendiente de cotizaci√≥n</option>
              <option value="en proceso">En proceso</option>
              <option value="incompleto">Incompleto</option>
              <option value="completo">Completada</option>
              <option value="finalizado">Finalizada</option>
              <option value="rechazado">Rechazada</option>
            </select>
          </div>
        
          <!-- Filtrar por Usuario -->
          <div class="filter-group">
            <h3 class="filter-header">Filtrar por usuario</h3>
            <label for="userFilter" class="sr-only">Filtrar por usuario</label>
            <select id="userFilter" class="filter-select" (change)="onUserChangeFilter($event)">
              <option value="">Seleccione un usuario</option>
              <option *ngFor="let usuario of usuarios" [value]="usuario.rut_usuario">
                {{ usuario.nom_usu }} {{usuario.ap_usu}}
              </option>
            </select>
          </div>
        
          <!-- Filtrar por Fecha -->
          <div class="filter-group">
            <h3 class="filter-header">Filtrar por Fecha</h3>
            <div class="date-filters">
              <div class="date-filter">
                <label for="monthSelect">Mes</label>
                <select id="monthSelect" class="filter-select">
                  <option value="0">Todos</option>
                  <!-- Opciones de meses se agregar√°n din√°micamente -->
                </select>
              </div>
              <div class="date-filter">
                <label for="yearSelect">A√±o</label>
                <select id="yearSelect" class="filter-select">
                  <option value="0">Todos</option>
                  <!-- Opciones de a√±os se agregar√°n din√°micamente -->
                </select>
              </div>
            </div>
          </div>
        
          <!-- Filtrar por Cliente -->
          <div class="filter-group">
            <h3 class="filter-header">Filtrar por Cliente</h3>
            <form class="search-form" (submit)="onClientSearch($event)">
              <input type="text" placeholder="Buscar por RUT Cliente" class="search-input" />
              <button type="submit" class="search-btn">Buscar</button>
            </form>
          </div>
        
          <!-- Filtrar por Equipo -->
          <div class="filter-group">
            <h3 class="filter-header">Filtrar por Equipo</h3>
            <form class="search-form" (submit)="onEquipmentSearch($event)">
              <input type="text" placeholder="Buscar equipo por n√∫mero de serie" class="search-input" />
              <button type="submit" class="search-btn">Buscar</button>
            </form>
          </div>
        </div>
        

        <table class="w-full border-collapse">
          <thead>
            <tr>
              <th class="border p-2 text-center">N√∫mero de orden</th>
              <th class="border p-2 text-center">Fecha de entrega</th>
              <th class="border p-2 text-center">N√∫mero de serie del producto</th>
              <th class="border p-2 text-center">Modelo del equipo</th>
              <th class="border p-2 text-center">Rut del cliente</th>
              <th class="border p-2 text-center">Estado de la OT</th>
              <th *ngIf="authService.getUserRole() != 2" class="border p-2 text-center">Rut del t√©cnico encargado</th>
              <th *ngIf="authService.getUserRole() != 2" class="border p-2 text-center">Nombre del t√©cnico encargado
              </th>
              <th class="border p-2 text-center">Fecha de plazo</th>
              <th class="border p-2 text-center">Solicitud Vista</th>
              <th class="border p-2 text-center">Operaciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let newOrder of filteredOrders | paginate: { itemsPerPage: itemsPerPage, currentPage: page }"
              class="align-middle text-center">
              <td class="border p-2">{{ newOrder.id_ot }}</td>
              <td class="border p-2">{{ newOrder.fec_entrega | date:'MM/dd' }}</td>
              <td class="border p-2">{{ newOrder.num_equipo }}</td>
              <td class="border p-2">{{ newOrder.Equipo?.mod_equipo }}</td>
              <td class="border p-2">{{ newOrder.rut_cliente }}</td>
              <td class="border p-2">{{ newOrder.VistaSolicitud?.nom_estado_ot }}</td>
              <td *ngIf="authService.getUserRole() != 2" class="border p-2">{{
                newOrder.VistaUltimaAdjudicacion?.rut_usuario }}</td>
              <td *ngIf="authService.getUserRole() != 2" class="border p-2">{{ newOrder.VistaUltimaAdjudicacion?.nom_usu
                }} {{newOrder.VistaUltimaAdjudicacion?.ap_usu}}</td>



              <td class="border p-2">
                <app-cronometro
                  [fechaPlazo]="newOrder.VistaSolicitud?.fecha_plazo | date:'yyyy-MM-ddTHH:mm'"></app-cronometro>
              </td>
              <td class="border p-2">
                <span *ngIf="newOrder.VistaSolicitud?.isview"><mat-icon>remove_red_eye</mat-icon></span>
                <span *ngIf="!newOrder.VistaSolicitud?.isview">
                  <mat-icon color="warn">remove_red_eye</mat-icon>
                </span>
              </td>
              <td class="border p-2">
                <button (click)="generatePDF(newOrder)" class="bg-blue-500 text-white p-1 rounded">üñ®Ô∏è</button>

                <button *ngIf="authService.getUserRole() === 2 && newOrder.VistaSolicitud?.id_estado_ot == 1 "
                  [routerLink]="['/edit-order', newOrder.id_ot]"
                  class="bg-yellow-500 text-white p-1 rounded">‚úèÔ∏è</button>
                <button *ngIf="authService.getUserRole() === 3 && newOrder.VistaSolicitud?.id_estado_ot == 2"
                  [routerLink]="['/edit-order-gestor', newOrder.id_ot]"
                  class="bg-yellow-500 text-white p-1 rounded">‚úèÔ∏è</button>
                <button *ngIf="authService.getUserRole() === 2 && newOrder.VistaSolicitud?.id_estado_ot == 3 "
                  [routerLink]="['/reportes/createReport', newOrder.id_ot]"
                  class="bg-yellow-500 text-white p-1 rounded">‚úèÔ∏è</button>
                <button
                  *ngIf="authService.getUserRole() === 3 && newOrder.VistaSolicitud?.id_estado_ot == 4 && newOrder.VistaSolicitud?.completada === false"
                  (click)="showSolicitudModal(newOrder.id_ot ?? 0)" class="bg-yellow-500 text-white p-1 rounded">
                  ‚úèÔ∏è
                </button>



                <div *ngIf="authService.getUserRole() === 3">
                  <button *ngIf="newOrder.id_ot !== undefined"
                    (click)="openEstadoModal(newOrder.id_ot, newOrder.VistaUltimaAdjudicacion?.rut_usuario ?? 0, newOrder.VistaSolicitud?.id_estado_ot ?? 0) ; onUsuarioChange($event)">üìÑ</button>
                </div>

                <div *ngIf="authService.getUserRole() === 3">
                  <button *ngIf="newOrder.id_ot !== undefined"
                    (click)="openEstadoModalCambio(newOrder.id_ot, newOrder.VistaUltimaAdjudicacion?.rut_usuario ?? 0, newOrder.VistaSolicitud?.id_estado_ot ?? 0) ; onUsuarioChange($event)">üëâüèª</button>
                </div>

                <div>
                  <button class="bg-red-500 text-white p-2 rounded hover:bg-red-600"
                    (click)="openRejectionModal(newOrder.id_ot ?? 0)">
                    ‚ùå
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>


        <pagination-controls (pageChange)="onPageChange($event)"></pagination-controls>


      </div>



      <div *ngIf="isRejectionModalOpen" class="modal-overlay">
        <div class="modal-content" [formGroup]="rejectionForm">
          <h2 class="text-xl font-bold mb-4">Elige la causa de rechazo</h2>

          <!-- Selector de causa de rechazo -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Causa de rechazo:</label>
            <select formControlName="id_rechazo" #estadoSelect class="w-full p-2 mb-4 border rounded" title="Causa de rechazo"
              (change)="onCausaChange($event, selectedOtId!)">
              <option value="">Seleccione una causa</option>
              <option *ngFor="let causa of causasRechazo" [value]="causa.id_rechazo">
                {{ causa.nombre_rechazo }}
              </option>
            </select>
          </div>

          <!--Descripci√≥n-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Descripci√≥n:</label>
            <textarea id="observaciones" [formGroup]="rejectionForm" formControlName="observaciones"
              class="w-full p-2 border rounded resize-none" rows="3"
              placeholder="Ingrese una descripci√≥n del cambio de estado...">
      </textarea>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex justify-end gap-2">
            <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" (click)="closeRejectionModal()">
              Cancelar
            </button>
            <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" type="submit"
              (click)="confirmRejection(selectedOtId!)">
              Confirmar
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="isEstadoModalOpen" class="modal-overlay">
        <div class="modal-content" [formGroup]="form">
          <h2 class="text-xl font-bold mb-4">Selecciona un estado</h2>

          <!--Selector de nuevo estado-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Estado: </label>
            <select formControlName="id_estado_ot" #estadoSelect class="w-full p-2 mb-4 border rounded" title="Estado"
              (change)="onUserChange($event, selectedOtId!)">
              <option value="">Seleccione un estado</option>
              <option *ngFor="let estado of estados" [value]="estado.id_estado_ot">
                {{ estado.nom_estado_ot }}
              </option>
            </select>
          </div>

          <!--Descripci√≥n-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Descripci√≥n:</label>
            <textarea id="desc_sol" [formGroup]="form" formControlName="desc_sol"
              class="w-full p-2 border rounded resize-none" rows="3"
              placeholder="Ingrese una descripci√≥n del cambio de estado...">
        </textarea>
          </div>


          <div class="mb-4">
            <label for="usuarios">Selecciona un Usuario:</label>
            <select id="rut_usuario_1" formControlName="rut_usuario" title="Selecciona un Usuario" (change)="onUsuarioChange($event)">
              <option *ngFor="let usuario of usuarios" [value]="usuario.rut_usuario">
                {{ usuario.nom_usu }} {{usuario.ap_usu}}
              </option>
            </select>
          </div>


          <!--Fecha de plazo-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Fecha Plazo:</label>
            <input [min]="fechaHoy" type="date" [formGroup]="form" formControlName="fecha_plazo"
              placeholder="A√±ada una descripci√≥n" class="w-full p-2 border rounded">
          </div>

          <!--botones-->
          <div class="flex justify-end gap-2">
            <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" (click)="closeEstadoModal()">
              Cancelar
            </button>
            <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" type="submit"
              (click)="confirmChangeEstado(selectedOtId!)">
              Aceptar
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="isEstadoModalOpen" class="modal-overlay">
        <div class="modal-content" [formGroup]="form">
          <h2 class="text-xl font-bold mb-4">Selecciona un estado</h2>

          <!--Selector de nuevo estado-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Estado: </label>
            <select formControlName="id_estado_ot" #estadoSelect class="w-full p-2 mb-4 border rounded"
              (change)="onUserChange($event, selectedOtId!)">
              <option value="">Seleccione un estado</option>
              <option *ngFor="let estado of estados" [value]="estado.id_estado_ot">
                {{ estado.nom_estado_ot }}
              </option>
            </select>
          </div>

          <!--Descripci√≥n-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Descripci√≥n:</label>
            <textarea id="desc_sol" [formGroup]="form" formControlName="desc_sol"
              class="w-full p-2 border rounded resize-none" rows="3"
              placeholder="Ingrese una descripci√≥n del cambio de estado...">
        </textarea>
          </div>





          <!--Fecha de plazo-->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Fecha Plazo:</label>
            <input [min]="fechaHoy" type="date" [formGroup]="form" formControlName="fecha_plazo"
              placeholder="A√±ada una descripci√≥n" class="w-full p-2 border rounded">
          </div>





          <!--botones-->
          <div class="flex justify-end gap-2">
            <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" (click)="closeEstadoModal()">
              Cancelar
            </button>
            <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" type="submit"
              (click)="confirmChangeEstado(selectedOtId!)">
              Aceptar
            </button>
          </div>
        </div>
      </div>


      <div *ngIf="isModalOpenFinalizado"
        class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg w-96">
          <h2 class="text-lg font-semibold mb-4">Crear Nueva Solicitud</h2>
          <form [formGroup]="formFin">
            <label for="desc_sol" class="block mb-2">Descripci√≥n de la solicitud:</label>
            <input id="desc_sol" formControlName="desc_sol" class="border p-2 rounded w-full"
              placeholder="Ingrese la descripci√≥n" />
            <div class="mt-4 flex justify-end gap-2">
              <button type="button" (click)="closeModalFinalizado()" class="bg-gray-500 text-white p-2 rounded">
                Cancelar
              </button>
              <button type="button" (click)="Finalizar(newOrderId ?? 0)" class="bg-blue-500 text-white p-2 rounded">
                Confirmar
              </button>
            </div>
          </form>
        </div>
      </div>


      <div *ngIf="isModalCambioEstadoOpen" class="modal-overlay">
        <div class="modal-content" [formGroup]="formUser">
          <h2 class="text-xl font-bold mb-4">Cambio de encargado de OT</h2>
          <div class="mb-4">
            <label for="usuarios">Selecciona un Usuario:</label>
            <select id="rut_usuario" formControlName="rut_usuario" (change)="onUsuarioChange($event)">
              <option *ngFor="let usuario of usuarios" [value]="usuario.rut_usuario">
                {{ usuario.nom_usu }} {{usuario.ap_usu}}
              </option>
            </select>
          </div>
          <!--botones-->
          <div class="flex justify-end gap-2">
            <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" (click)="closeEstadoAdjudicacion()">
              Cancelar
            </button>
            <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" type="submit"
              (click)="confirmAdjudicacion(selectedOtId!)">
              Aceptar
            </button>
          </div>
        </div>
      </div>