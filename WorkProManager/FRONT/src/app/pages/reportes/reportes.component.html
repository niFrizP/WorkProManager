<div class="wpm-custom-gradient p-6 rounded-lg shadow-md">
  <div class="contenedor">
    <div *ngIf="authService.getUserId() as rut">
      <p>Bienvenido, usuario con RUT: {{ rut }}</p>
      <h1 class="text-2xl font-bold text-center mb-4">Reportes</h1>
    </div>

  <div class="flex justify-between items-center mb-4">
    <div class="filtros">
      <h2 class="text-xl font-semibold mb-4 cursor-pointer" (click)="isFiltrosOpen = !isFiltrosOpen">Filtros</h2>
      <div *ngIf="isFiltrosOpen">
        <!--filtro por estado-->
        <div class="filtro">
          <h3 (click)="isEstadoOpen = !isEstadoOpen">Filtrar por estado</h3>
          <div *ngIf="isEstadoOpen">
            <select #filterSelect class="p2 border rounded" (change)="filterOrdersByStatus(filterSelect.value)">
              <option value="todas">Todas</option>
              <option value="pendiente">Pendiente</option>
              <option value="en proceso">En proceso</option>
              <option value="incompleto">incompleto</option>
              <option value="completo">completo</option>
              <option value="finalizado">finalizado</option>
              <option value="rechazado">rechazado</option>
            </select>
          </div>
        </div>

        <!--filtro por usuario-->
        <div class="filtro">
          <h3 (click)="isUsuarioOpen = !isUsuarioOpen">Filtrar por usuario</h3>
          <div *ngIf="isUsuarioOpen">
            <select #filterSelect class="p2 border rounded" [(ngModel)]="selectedUsuario" (change)="filterOrdersByUsuario(selectedUsuario)">
              <option *ngFor="let usuario of usuarios" [value]="usuario.nom_usu"> {{ usuario.nom_usu}} {{ usuario.ap_usu}}</option>
            </select>
          </div>
        </div>

        <!--filtro por fecha-->
        <div class="filtro">
          <h3 (click)="isFechaOpen = !isFechaOpen">Filtrar por Fecha</h3>
          <div *ngIf="isFechaOpen">
            <label for="monthSelect" class="mr-2 font-medium">Mes</label>
            <select #monthSelect class="p-2 border rounded" (change)="filterOrdersByMonthYear(+monthSelect.value, +yearSelect.value)">
              <option value="0">Todos</option>
              <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
            </select>
            <label for="yearSelect" class="ml-4 mr-2 font-medium">A√±o</label>
            <select #yearSelect class="p-2 border rounded" (change)="filterOrdersByMonthYear(+monthSelect.value, +yearSelect.value)">
              <option value="0">Todos</option>
              <option *ngFor="let year of years">{{ year }}</option>
            </select>
          </div>
        </div>

        <!--filtro por cliente-->
        <div class="filtro">
          <h3 (click)="isClienteOpen = !isClienteOpen">Filtrar por Cliente</h3>
          <div *ngIf="isClienteOpen">
            <form class="search-form" (submit)="filterOrdersByRutCliente()">
              <input
                type="text"
                placeholder="Buscar por RUT Cliente"
                [(ngModel)]="searchRutCliente"
                (input)="filterOrdersByRutCliente()"
                class="search-input"
                name="rut_cliente"
              />
              <button type="submit" class="search-btn">Buscar</button>
            </form>
          </div>
        </div>

        <!--filtro por equipo-->
        <div class="filtro">
          <h3 (click)="isEquipoOpen = !isEquipoOpen">Filtrar por Equipo</h3>
          <div *ngIf="isEquipoOpen">
            <form class="search-form" (submit)="filterOrdersByEquipo()">
              <input
                type="text"
                placeholder="Buscar equipo por n√∫mero de serie"
                [(ngModel)]="searchEquipo"
                (input)="filterOrdersByEquipo()"
                class="search-input"
                name="num_equipo"
              />
              <button type="submit" class="search-btn">Buscar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <table class="w-full border-collapse">
    <thead>
      <tr>
        <th class="border p-2">Fecha de entrega</th>
        <th class="border p-2">Tiempo</th>
        <th class="border p-2">Equipo</th>
        <th class="border p-2">OT ID</th>
        <th class="border p-2">Descripci√≥n</th>
        <th class="border p-2">Equipo</th>
        <th class="border p-2">Rut Cliente</th>
        <th class="border p-2">Estado</th>
        <th class="border p-2">Usuario</th>
        <th class="border p-2">cronometro</th>

      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let newOrder of filteredOrders | paginate: { itemsPerPage: itemsPerPage, currentPage: page }"
      [ngClass]="{ 'text-red-600': newOrder.VistaSolicitud.isview }">
        

      

        <td>{{ newOrder.fec_entrega }}</td>
        <td>{{ newOrder.VistaSolicitud.fecha_plazo }}</td>
        <!-- src/app/components/cronometro/cronometro.component.html -->


        <td>{{ newOrder.num_equipo }}</td>
        <td>{{ newOrder.id_ot }}</td>
        <td>{{ newOrder.descripcion }}</td>
        <td>{{ newOrder.Equipo.mod_equipo }}</td>
        <td>{{ newOrder.rut_cliente }}</td>
        <td> 
          {{ newOrder.EstadoOT.nom_estado_ot }}</td>
        <td>{{ newOrder.Usuario.nom_usu }}</td>
        <td>
          <app-cronometro [fechaPlazo]="newOrder.VistaSolicitud.fecha_plazo | date:'yyyy-MM-ddTHH:mm:ss'"></app-cronometro>
        </td>
        <td><span *ngIf="newOrder.VistaSolicitud.isview">
          ‚ö†Ô∏è 
        </span>
        <span *ngIf="!newOrder.VistaSolicitud.isview">
          ‚úÖ
        </span></td>
        <td>
          <button [routerLink]="['createReport/', newOrder.id_ot]">‚úèÔ∏è</button>
          <div *ngIf="authService.getUserRole() === 3">
            <button *ngIf="newOrder.id_ot !== undefined" (click)="openEstadoModal(newOrder.id_ot)">üìÑ</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <pagination-controls (pageChange)="onPageChange($event)"></pagination-controls>

  <div *ngIf="isEstadoModalOpen" class="modal-overlay">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Selecciona un estado</h2>
      
      <!--Selector de nuevo estado-->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Estado: </label>
        <select 
          #estadoSelect 
          class="w-full p-2 mb-4 border rounded"
          (change)="onUserChange($event, selectedOtId!)">
          <option value="">Seleccione un estado</option>
          <option *ngFor="let estado of estados" [value]="estado.id_estado_ot">
            {{ estado.nom_estado_ot }}
          </option>
        </select>
      </div>

      <!--Descripci√≥n-->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Descripci√≥n:</label>
        <textarea 
          [formGroup]="form"
          formControlName="desc_sol"
          class="w-full p-2 border rounded resize-none"
          rows="3"
          placeholder="Ingrese una descripci√≥n del cambio de estado...">
        </textarea>
      </div>

      <!--Fecha de plazo-->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Fecha Plazo:</label>
        <input 
          type="date"
          [formGroup]="form"
          formControlName="fecha_plazo"
          placeholder="A√±ada una descripci√≥n"
          class="w-full p-2 border rounded">
      </div>

      <!--botones-->
      <div class="flex justify-end gap-2">
        <button 
          class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          (click)="closeEstadoModal()">
          Cancelar
        </button>
        <button 
          class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          (click)="confirmChangeEstado(selectedOtId!)">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>


